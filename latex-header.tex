%% ============================================================
%% CABLES.GL BOOK - EASY-TO-CHANGE SETTINGS
%% ============================================================

%% Enable two-column landscape layout
% This will be set by Pandoc via classoption=twocolumn,landscape
% But we ensure it's active at document start
\AtBeginDocument{%
  \if@twocolumn\else%
    \twocolumn%
  \fi%
}

%% ------------------------------------------------------------
%% SECTION HEADINGS - Font Sizes & Leading
%% Format: FontSize in pt, Leading = line height
%% ------------------------------------------------------------
\newcommand{\SectionOneFontSize}{18}      % Chapter titles
\newcommand{\SectionOneLeading}{16}
\newcommand{\SectionTwoFontSize}{17}      % Major sections
\newcommand{\SectionTwoLeading}{13}
\newcommand{\SectionThreeFontSize}{14}    % Subsections (op names)
\newcommand{\SectionThreeLeading}{12}
\newcommand{\SectionThreeSpacingBefore}{4.0ex}  % Spacing before subsections
\newcommand{\SectionThreeSpacingAfter}{1.5ex plus 0.5ex minus 0.2ex}  % Spacing after subsections
\newcommand{\SectionFourFontSize}{12}     % Paragraph headers
\newcommand{\SectionFourLeading}{10}

%% ------------------------------------------------------------
%% SECTION HEADINGS - Colors (RGB 0-255)
%% ------------------------------------------------------------
\newcommand{\SectionOneColorRed}{75}      % Chapter titles - dark gray
\newcommand{\SectionOneColorGreen}{75}
\newcommand{\SectionOneColorBlue}{75}
\newcommand{\SectionTwoColorRed}{0}       % Major sections - dark blue
\newcommand{\SectionTwoColorGreen}{40}
\newcommand{\SectionTwoColorBlue}{120}
\newcommand{\SectionThreeColorRed}{51}    % Subsections - dark gray
\newcommand{\SectionThreeColorGreen}{51}
\newcommand{\SectionThreeColorBlue}{151}
\newcommand{\SectionFourColorRed}{51}     % Paragraph headers - dark gray
\newcommand{\SectionFourColorGreen}{51}
\newcommand{\SectionFourColorBlue}{51}

%% ------------------------------------------------------------
%% OPS SECTION - Port Symbol Colors (RGB 0-255)
%% ------------------------------------------------------------
\newcommand{\InputPortSymbolRed}{0}       % > symbol color (dark green)
\newcommand{\InputPortSymbolGreen}{128}
\newcommand{\InputPortSymbolBlue}{0}
\newcommand{\OutputPortSymbolRed}{0}      % < symbol color (dark green)
\newcommand{\OutputPortSymbolGreen}{128}
\newcommand{\OutputPortSymbolBlue}{0}

%% ------------------------------------------------------------
%% OPS SECTION - Spacing & Layout
%% ------------------------------------------------------------
\newcommand{\OpImageHeightFraction}{0.18}  % Op image MAX height fraction of \textheight (smaller = smaller images)
\newcommand{\OpImageWidthFraction}{1.00}   % Safety cap: max width fraction of \columnwidth
\newcommand{\OpImageSpacing}{0.15\baselineskip}  % Spacing before/after op images
\newcommand{\OpParagraphSpacing}{0.9\parskip}  % Paragraph spacing in ops
\newcommand{\OpsSectionLeading}{1.1}      % Line spacing in ops sections

%% ------------------------------------------------------------
%% CODE BLOCKS
%% ------------------------------------------------------------
\newcommand{\CodeBlockFontSize}{10.75}     % Font size in points
\newcommand{\CodeBlockLeadingPt}{11.75}  % Line height (leading) in points (~+10% over 10.5pt)
\newcommand{\CodeBlockLineSpacing}{0.95}  % Extra multiplier (1.0 = none). Keep for fine-tuning.

%% ------------------------------------------------------------
%% IMAGES
%% ------------------------------------------------------------
\newcommand{\ImageWidthFraction}{1.0}     % General image width (0.95 = 95% of column width for 2-col layout)
\newcommand{\YouTubeThumbnailWidthFraction}{0.5}     % YouTube thumbnail width (0.33 = 33% of column width for 2-col layout)

%% ------------------------------------------------------------
%% PAGE LAYOUT
%% ------------------------------------------------------------
\newcommand{\PagePaper}{a4paper}         % Page size (a4paper, letterpaper, ...)
\newcommand{\PageMarginLeft}{0.45in}     % Left margin (25% smaller than 0.82in)
\newcommand{\PageMarginRight}{0.45in}    % Right margin (25% smaller than 0.82in)
\newcommand{\PageMarginTop}{0.4in}       % Top margin
\newcommand{\PageMarginBottom}{0.3in}   % Bottom margin
\newcommand{\HeaderHeight}{6}            % Header height in points
\newcommand{\FooterHeight}{6}            % Footer height in points
\newcommand{\FooterSkip}{5pt}            % Distance from text bottom to footer (lower = closer to page edge)
\newcommand{\FooterVerticalOffset}{-7pt} % Vertical offset for page number (negative = closer to page edge)
\newcommand{\PageNumberGrayPercent}{50}  % Page number color (black!75)
\newcommand{\PageNumberFontSeries}{sb}   % Page number weight (sb=semibold, bf=bold)
\newcommand{\ColumnGutterWidth}{0.3in}  % Space between columns in 2-column layout (tripled from default ~0.14in)

%% ------------------------------------------------------------
%% CARDS (Video blocks + Code blocks)
%% ------------------------------------------------------------
\newcommand{\CardGrayPercent}{10}         % Background gray level (black!10 ~= very light)
\newcommand{\CardCornerRadius}{4pt}       % Rounded corners
\newcommand{\CardPaddingX}{8pt}           % Inner left/right padding
\newcommand{\CardPaddingY}{12pt}          % Inner top/bottom padding
\newcommand{\VideoCardFontSizePt}{14.0}   % Video card font size (pt) (~+15% over 11pt)
\newcommand{\VideoCardLeadingPt}{18.0}    % Video card leading/line-height (pt)
\newcommand{\VideoCardSpacingBefore}{0.75\baselineskip} % Space before a video card (when not following another video card)
\newcommand{\VideoCardSpacingBetweenCards}{0.75\baselineskip} % Space between consecutive video cards (2x previous)
\newcommand{\YouTubeThumbCornerRadius}{5pt} % Rounded corners for YouTube thumbnails only

%% ------------------------------------------------------------
%% ORPHAN CONTROL (Headings)
%% ------------------------------------------------------------
% Keep headings with at least a few lines of content after them (prevents orphan titles)
\newcommand{\NeedspaceSection}{10\baselineskip}
\newcommand{\NeedspaceSubsection}{8\baselineskip}
\newcommand{\NeedspaceSubsubsection}{6\baselineskip}
\newcommand{\NeedspaceParagraph}{4\baselineskip}
\newcommand{\NeedspaceOpHeading}{10\baselineskip} % Ops (###) heading + image + a bit of text (prevents orphan op titles)

%% ============================================================
%% END OF EASY-TO-CHANGE SETTINGS
%% ============================================================

%% Apply 2-column gutter width (space between columns)
\AtBeginDocument{%
  \setlength{\columnsep}{\ColumnGutterWidth}%
}

%% Apply page size + margins (landscape is handled here)
\usepackage{geometry}
\geometry{
  paper=\PagePaper,
  landscape,
  left=\PageMarginLeft,
  right=\PageMarginRight,
  top=\PageMarginTop,
  bottom=\PageMarginBottom
}


%% Basic packages
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{xstring}  % For string comparison in image handling
\usepackage{ragged2e} % For better left alignment
\usepackage{setspace} % For line spacing control
\usepackage{etoolbox} % For hooks and patches
\usepackage{multicol} % For flexible column handling
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage{needspace} % For preventing orphans
% longtable is needed even when Pandoc skips it; patched in AtBeginDocument

%% Prevent orphan headings (heading at end of column/page with no content after)
\AtBeginDocument{%
  % Reserve space BEFORE the heading, and strongly discourage a break immediately after it.
  \pretocmd{\section}{\Needspace{\NeedspaceSection}\nopagebreak[4]}{}{}%
  \pretocmd{\subsection}{\Needspace{\NeedspaceSubsection}\nopagebreak[4]}{}{}%
  \pretocmd{\subsubsection}{\Needspace{\NeedspaceSubsubsection}\nopagebreak[4]}{}{}%
  \pretocmd{\paragraph}{\Needspace{\NeedspaceParagraph}\nopagebreak[4]}{}{}%
}

%% Image handling - scale images and left-align
\usepackage{adjustbox}
\usepackage{float}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\scaledwidth{\ImageWidthFraction\maxwidth}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\ImageWidthFraction\linewidth,height=\maxheight,keepaspectratio}

%% Force all images to be left-aligned (no centering)
\usepackage{caption}
\captionsetup{labelformat=empty,textformat=empty,justification=raggedright,singlelinecheck=false}

%% Completely override figure environment and centering to force left alignment
\makeatletter
% Override centering command globally to do left alignment
\renewcommand{\centering}{%
  \rightskip0pt plus 1fil
  \leftskip0pt
  \parfillskip0pt
  \raggedright
}
% Override center environment to be left-aligned
\renewenvironment{center}{%
  \par\noindent%
  \raggedright%
  \hspace{0pt}%
}{%
  \par%
}
% Completely replace figure environment - remove any text that might appear
\makeatletter
\renewenvironment{figure}[1][htbp]{%
  \def\@captype{figure}%
  \global\@opimagefalse
  % Do NOT call \needspace here for ops images.
  % We reserve space at the op heading instead, to avoid leaving the heading orphaned.
  \par\vspace{\OpImageSpacing}%
  \noindent%
  \raggedright%
  \hspace{0pt}%
}{%
  \if@opimage
    % Op image: match before-space exactly by using negative space to cancel extra
    \par\vspace{-\baselineskip}% Cancel default spacing
    \vspace{-\parskip}% Cancel paragraph skip  
    \vspace{\OpImageSpacing}% Add exact spacing we want (same as before)
  \else
    % Regular figure: standard spacing
    \par\vspace{\baselineskip}%
  \fi
}
% Completely disable floatboxreset (which often centers)
\let\@floatboxreset\relax
\makeatother

%% Force left alignment for ALL includegraphics commands
%% Special handling for op images (in images/ops/ folder)
\makeatletter
\newif\if@opimage
\let\oldincludegraphics\includegraphics
\newcommand{\isopimage}[1]{%
  \IfSubStr{#1}{images/ops/}{\@firstoftwo}{\@secondoftwo}%
}
\renewcommand{\includegraphics}[2][]{%
  \isopimage{#2}{%
    % Op image: mark flag globally and insert image
    \global\@opimagetrue
    % Ops images: scale by a fixed max HEIGHT (consistent across varying aspect ratios),
    % with a width cap to prevent overflow in a column.
    \noindent\oldincludegraphics[height=\OpImageHeightFraction\textheight,width=\OpImageWidthFraction\columnwidth,keepaspectratio]{#2}%
  }{%
    % Regular image: use standard settings
    \global\@opimagefalse
    \par\noindent%
    \oldincludegraphics[#1]{#2}%
    \par%
  }%
}
\makeatother

%% TOC spacing
\usepackage{tocloft}
\setlength{\cftsecnumwidth}{2.5em}
\setlength{\cftsubsecnumwidth}{3.2em}
\setlength{\cftsubsubsecnumwidth}{4em}
\setlength{\cftparanumwidth}{4.8em}

%% Font fallbacks
\usepackage{fontspec}

%% Define colors using the variables above
\definecolor{sectiononecolor}{RGB}{\SectionOneColorRed,\SectionOneColorGreen,\SectionOneColorBlue}
\definecolor{sectiontwocolor}{RGB}{\SectionTwoColorRed,\SectionTwoColorGreen,\SectionTwoColorBlue}
\definecolor{sectionthreecolor}{RGB}{\SectionThreeColorRed,\SectionThreeColorGreen,\SectionThreeColorBlue}
\definecolor{sectionfourcolor}{RGB}{\SectionFourColorRed,\SectionFourColorGreen,\SectionFourColorBlue}
\definecolor{linkblue}{RGB}{0,102,204}
\definecolor{inputportsymbol}{RGB}{\InputPortSymbolRed,\InputPortSymbolGreen,\InputPortSymbolBlue}
\definecolor{outputportsymbol}{RGB}{\OutputPortSymbolRed,\OutputPortSymbolGreen,\OutputPortSymbolBlue}

%% TOC: color ONLY level-2 entries (subsections) in blue; keep others dark gray
\renewcommand{\cftsecfont}{\color{sectiononecolor}}
\renewcommand{\cftsecpagefont}{\color{sectiononecolor}}
\renewcommand{\cftsubsecfont}{\color{sectiontwocolor}}
\renewcommand{\cftsubsecpagefont}{\color{sectiontwocolor}}
\renewcommand{\cftsubsubsecfont}{\color{sectiononecolor}}
\renewcommand{\cftsubsubsecpagefont}{\color{sectiononecolor}}
\renewcommand{\cftparafont}{\color{sectiononecolor}}
\renewcommand{\cftparapagefont}{\color{sectiononecolor}}

%% Commands for colored port symbols (with space after)
\newcommand{\inputsymbol}{\textcolor{inputportsymbol}{\textgreater} }
\newcommand{\outputsymbol}{\textcolor{outputportsymbol}{\textless} }

%% Ops numbering helper:
%% Use section.subsubsection (e.g. 13.12) instead of section.subsection.subsubsection (e.g. 13.1.12)
%% Used by the small latex block inserted at the top of each ops (chapters/13-*.md) file.
\newcommand{\OpsSubsubNoSubsectionNumbering}{%
  \renewcommand{\thesubsubsection}{\thesection.\arabic{subsubsection}}%
  \renewcommand{\theHsubsubsection}{\theHsection.\arabic{subsubsection}}%
}

%% Custom header styles using the settings above
\usepackage{titlesec}

%% Section 1 - largest (chapter titles)
\titleformat{\section}
  {\fontsize{\SectionOneFontSize}{\SectionOneLeading}\bfseries\color{sectiononecolor}}
  {\thesection}{1em}{}

%% Section 2 (major sections)
\titleformat{\subsection}
  {\fontsize{\SectionTwoFontSize}{\SectionTwoLeading}\bfseries\color{sectiontwocolor}}
  {\thesubsection}{1em}{}

%% Section 3 (subsections)
\titleformat{\subsubsection}
  {\fontsize{\SectionThreeFontSize}{\SectionThreeLeading}\bfseries\color{sectionthreecolor}}
  {\thesubsubsection}{1em}{}
%% Reduce spacing after ### headings (before op images)
%% Format: \titlespacing{command}{left}{before-sep}{after-sep}
\titlespacing*{\subsubsection}{0pt}{\SectionThreeSpacingBefore}{\SectionThreeSpacingAfter}

%% Apply reduced paragraph spacing to ops sections (section 13 content)
%% Also prevent orphans (op names alone at page bottom)
\makeatletter
\pretocmd{\subsubsection}{%
  \ifnum\value{section}=13\relax
    \setlength{\parskip}{\OpParagraphSpacing}%
    % Prevent orphan op names - reserve enough room for heading + op image + some text
    \needspace{\NeedspaceOpHeading}%
  \fi
}{}{}
\makeatother

%% Orphan and widow control
\clubpenalty=10000      % Prevent orphan lines at start of page
\widowpenalty=10000     % Prevent widow lines at end of page
\displaywidowpenalty=10000  % Prevent widows in display math

%% Section 4 / Paragraph - not numbered
\titleformat{\paragraph}
  {\fontsize{\SectionFourFontSize}{\SectionFourLeading}\bfseries\color{sectionfourcolor}}
  {}{0em}{}

%% Set section numbering depth to 3
\setcounter{secnumdepth}{3}

%% Code block styling
\usepackage{fancyvrb}
\usepackage{fvextra} % enables automatic line breaking for Verbatim environments
\usepackage[framemethod=tikz]{mdframed}

% Card background (shared by code blocks + video cards)
\colorlet{cardbg}{black!\CardGrayPercent}

\mdfdefinestyle{cardstyle}{
    backgroundcolor=cardbg,
    linecolor=cardbg,
    linewidth=0pt,
    innerleftmargin=\CardPaddingX,
    innerrightmargin=\CardPaddingX,
    innertopmargin=\CardPaddingY,
    innerbottommargin=\CardPaddingY,
    leftmargin=0pt,
    rightmargin=0pt,
    roundcorner=\CardCornerRadius,
    skipabove=1.5\baselineskip,
    skipbelow=\baselineskip
}

% Code blocks use the same card style
\mdfdefinestyle{codeboxstyle}{style=cardstyle}

% Video cards: keep cardstyle, but make left/right padding match the (good) top padding
\mdfdefinestyle{videocardstyle}{
    style=cardstyle,
    innerleftmargin=\CardPaddingY,
    innerrightmargin=\CardPaddingY
}

% Make code blocks span both columns if they're wide (in 2-column mode)
% Note: This will be handled at document level, not in preamble

%% Set code block font + wrapping.
%% NOTE: fancyvrb's `fontsize=` expects a command (e.g. \small). Passing "10.5pt"
%% causes that text to appear in the output. Use `formatcom` instead.
\newcommand{\CodeBlockFormat}{%
  \fontsize{\CodeBlockFontSize}{\CodeBlockLeadingPt}\selectfont%
  \linespread{\CodeBlockLineSpacing}\selectfont%
}
\DefineVerbatimEnvironment{Verbatim}{Verbatim}{
    formatcom=\CodeBlockFormat,
    breaklines=true,
    breakanywhere=true,
    breakautoindent=false,
    breakindent=0pt,
    breaksymbolleft={},
    xleftmargin=0pt,
    xrightmargin=0pt
}

% Pandoc often emits the lowercase `verbatim` environment.
% Re-customize it to use fancyvrb/fvextra so long lines wrap inside code boxes.
\RecustomVerbatimEnvironment{verbatim}{Verbatim}{
    formatcom=\CodeBlockFormat,
    breaklines=true,
    breakanywhere=true,
    breakautoindent=false,
    breakindent=0pt,
    breaksymbolleft={},
    xleftmargin=0pt,
    xrightmargin=0pt
}

\surroundwithmdframed[style=codeboxstyle]{Verbatim}
\surroundwithmdframed[style=codeboxstyle]{verbatim}

%% Page headers and footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{} % Clear all headers and footers
\fancyfoot[R]{\raisebox{\FooterVerticalOffset}{\textcolor{black!\PageNumberGrayPercent}{{\fontseries{\PageNumberFontSeries}\selectfont\thepage}}}} % Right-aligned page number (styled)
\renewcommand{\headrulewidth}{0pt} % No header rule
\renewcommand{\footrulewidth}{0pt} % No footer rule

% Set header and footer heights with vertically centered page number
\setlength{\headheight}{\HeaderHeight pt}
\setlength{\footskip}{\FooterSkip}

% Vertically center page number in footer
\fancyfootoffset{0pt}
\renewcommand{\footruleskip}{0pt}

% Fix page 1 (plain style) to also have right-aligned page number
\fancypagestyle{plain}{%
  \fancyhf{} % Clear all headers and footers
  \fancyfoot[R]{\raisebox{\FooterVerticalOffset}{\textcolor{black!\PageNumberGrayPercent}{{\fontseries{\PageNumberFontSeries}\selectfont\thepage}}}} % Right-aligned page number (styled)
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

%% Link colors and final image alignment fixes
\AtBeginDocument{
  \hypersetup{
    colorlinks=true,
    linkcolor=sectiononecolor,
    urlcolor=linkblue,
    citecolor=sectiononecolor,
    filecolor=sectiononecolor
  }
  % Final override to ensure figures are left-aligned
  \makeatletter
  \renewcommand{\centering}{%
    \rightskip0pt plus 1fil
    \leftskip0pt
    \parfillskip0pt
    \raggedright
  }
  \renewenvironment{center}{%
    \par\noindent%
    \raggedright%
    \hspace{0pt}%
  }{%
    \par%
  }
  % Make TOC span both columns (longtable requires 1-column mode)
  \let\oldtableofcontents\tableofcontents
  \renewcommand{\tableofcontents}{%
    \if@twocolumn
      \onecolumn
      \oldtableofcontents
      \twocolumn
    \else
      \oldtableofcontents
    \fi
  }
  % Code blocks will stay in their column for now
  % (Can be enhanced later to span both columns if needed)
  \makeatother
}

% Patch longtable to work in 2-column mode
% We'll register hooks after document begins to avoid mode issues
\AtBeginDocument{
  \makeatletter
  \newif\iflongtabletwocol
  \let\origlongtable\longtable
  \let\endoriglongtable\endlongtable
  % Automatically switch to single column for longtable, then restore
  \renewenvironment{longtable}{%
    \if@twocolumn
      \longtabletwocoltrue
      \onecolumn
      \global\@twocolumnfalse % Satisfy longtable's 1-column requirement
    \else
      \longtabletwocolfalse
    \fi
    \origlongtable
  }{%
    \endoriglongtable
    \iflongtabletwocol
      \twocolumn
    \fi
  }
  \makeatother
}
