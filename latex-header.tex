%% ============================================================
%% CABLES.GL BOOK - EASY-TO-CHANGE SETTINGS
%% ============================================================

%% Enable two-column landscape layout
% This will be set by Pandoc via classoption=twocolumn,landscape
% But we ensure it's active at document start
\AtBeginDocument{%
  \if@twocolumn\else%
    \twocolumn%
  \fi%
}

%% ------------------------------------------------------------
%% SECTION HEADINGS - Font Sizes & Leading
%% Format: FontSize in pt, Leading = line height
%% ------------------------------------------------------------
\newcommand{\SectionOneFontSize}{20}      % Chapter titles
\newcommand{\SectionOneLeading}{16}
\newcommand{\SectionTwoFontSize}{16}      % Major sections
\newcommand{\SectionTwoLeading}{14}
\newcommand{\SectionThreeFontSize}{14}    % Subsections (op names)
\newcommand{\SectionThreeLeading}{12}
\newcommand{\SectionThreeSpacingBefore}{4.0ex}  % Spacing before subsections
\newcommand{\SectionThreeSpacingAfter}{1.5ex plus 0.5ex minus 0.2ex}  % Spacing after subsections
\newcommand{\SectionFourFontSize}{12}     % Paragraph headers
\newcommand{\SectionFourLeading}{11}

%% ------------------------------------------------------------
%% SECTION HEADINGS - Colors (RGB 0-255)
%% ------------------------------------------------------------
\newcommand{\SectionOneColorRed}{51}      % Chapter titles - dark gray
\newcommand{\SectionOneColorGreen}{51}
\newcommand{\SectionOneColorBlue}{51}
\newcommand{\SectionTwoColorRed}{0}       % Major sections - dark blue
\newcommand{\SectionTwoColorGreen}{40}
\newcommand{\SectionTwoColorBlue}{120}
\newcommand{\SectionThreeColorRed}{51}    % Subsections - dark gray
\newcommand{\SectionThreeColorGreen}{51}
\newcommand{\SectionThreeColorBlue}{151}
\newcommand{\SectionFourColorRed}{51}     % Paragraph headers - dark gray
\newcommand{\SectionFourColorGreen}{51}
\newcommand{\SectionFourColorBlue}{51}

%% ------------------------------------------------------------
%% OPS SECTION - Port Symbol Colors (RGB 0-255)
%% ------------------------------------------------------------
\newcommand{\InputPortSymbolRed}{0}       % > symbol color (dark green)
\newcommand{\InputPortSymbolGreen}{128}
\newcommand{\InputPortSymbolBlue}{0}
\newcommand{\OutputPortSymbolRed}{0}      % < symbol color (dark green)
\newcommand{\OutputPortSymbolGreen}{128}
\newcommand{\OutputPortSymbolBlue}{0}

%% ------------------------------------------------------------
%% OPS SECTION - Spacing & Layout
%% ------------------------------------------------------------
\newcommand{\OpImageWidthFraction}{1.00}   % Op image width (0.90 = 90% of column width for 2-col layout)
\newcommand{\OpImageSpacing}{0.15\baselineskip}  % Spacing before/after op images
\newcommand{\OpParagraphSpacing}{0.95\parskip}  % Paragraph spacing in ops
\newcommand{\OpsSectionLeading}{1.1}      % Line spacing in ops sections

%% ------------------------------------------------------------
%% CODE BLOCKS
%% ------------------------------------------------------------
\newcommand{\CodeBlockFontSize}{10.5}     % Font size in points
\newcommand{\CodeBlockLineSpacing}{0.9}  % Line spacing (1.0 = normal)

%% ------------------------------------------------------------
%% IMAGES
%% ------------------------------------------------------------
\newcommand{\ImageWidthFraction}{1.0}     % General image width (0.95 = 95% of column width for 2-col layout)
\newcommand{\YouTubeThumbnailWidthFraction}{0.40}     % YouTube thumbnail width (0.33 = 33% of column width for 2-col layout)

%% ------------------------------------------------------------
%% PAGE LAYOUT
%% ------------------------------------------------------------
\newcommand{\PagePaper}{a4paper}          % Page size (a4paper, letterpaper, ...)
\newcommand{\PageMarginLeft}{0.5in}     % Left margin (25% smaller than 0.82in)
\newcommand{\PageMarginRight}{0.5in}    % Right margin (25% smaller than 0.82in)
\newcommand{\PageMarginTop}{0.5in}      % Top margin
\newcommand{\PageMarginBottom}{0.5in}   % Bottom margin
\newcommand{\HeaderHeight}{7}            % Header height in points
\newcommand{\FooterHeight}{8}          % Footer height in points
\newcommand{\FooterSkip}{5pt}            % Distance from text bottom to footer (lower = closer to page edge)
\newcommand{\FooterVerticalOffset}{-21pt}  % Vertical offset for page number (negative = closer to page edge)
\newcommand{\ColumnGutterWidth}{0.3in}  % Space between columns in 2-column layout (tripled from default ~0.14in)
\newcommand{\ThreeColumnGutterWidth}{0.1in} % Space between columns in 3-column layout
\newcommand{\OpsColumnsCount}{3}          % Columns for Ops chapters
\newcommand{\VideoTutorialsColumnsCount}{3} % Columns for Chapter 12 (Video Tutorials)

%% ------------------------------------------------------------
%% CARDS (Video blocks + Code blocks)
%% ------------------------------------------------------------
\newcommand{\CardGrayPercent}{10}         % Background gray level (black!10 ~= very light)
\newcommand{\CardCornerRadius}{4pt}       % Rounded corners
\newcommand{\CardPaddingX}{8pt}           % Inner left/right padding
\newcommand{\CardPaddingY}{12pt}          % Inner top/bottom padding
\newcommand{\VideoCardFontSizePt}{12.75}   % Video card font size (pt) (~+15% over 11pt)
\newcommand{\VideoCardLeadingPt}{16.0}    % Video card leading/line-height (pt)
\newcommand{\VideoCardSpacingBefore}{0.75\baselineskip} % Space before a video card (when not following another video card)
\newcommand{\VideoCardSpacingBetweenCards}{0.375\baselineskip} % Space between consecutive video cards (50% of normal)
\newcommand{\YouTubeThumbCornerRadius}{4pt} % Rounded corners for YouTube thumbnails only

%% ============================================================
%% END OF EASY-TO-CHANGE SETTINGS
%% ============================================================

%% Apply 2-column gutter width (space between columns)
\AtBeginDocument{%
  \setlength{\columnsep}{\ColumnGutterWidth}%
}

%% Apply page size + margins (landscape is handled here)
\usepackage{geometry}
\geometry{
  paper=\PagePaper,
  landscape,
  left=\PageMarginLeft,
  right=\PageMarginRight,
  top=\PageMarginTop,
  bottom=\PageMarginBottom
}

%% 3-column layout helpers (switch to one-column, then use multicols across page)
\makeatletter
\newenvironment{OpsThreeCols}{%
  \if@twocolumn\onecolumn\fi
  \setlength{\columnsep}{\ThreeColumnGutterWidth}%
  \begin{multicols}{\OpsColumnsCount}%
}{%
  \end{multicols}%
  \twocolumn%
}

\newenvironment{VideoTutorialsThreeCols}{%
  \if@twocolumn\onecolumn\fi
  \setlength{\columnsep}{\ThreeColumnGutterWidth}%
  \begin{multicols}{\VideoTutorialsColumnsCount}%
}{%
  \end{multicols}%
  \twocolumn%
}
\makeatother


%% Basic packages
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{xstring}  % For string comparison in image handling
\usepackage{ragged2e} % For better left alignment
\usepackage{setspace} % For line spacing control
\usepackage{etoolbox} % For hooks and patches
\usepackage{multicol} % For flexible column handling
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage{needspace} % For preventing orphans
% longtable is needed even when Pandoc skips it; patched in AtBeginDocument

%% Image handling - scale images and left-align
\usepackage{adjustbox}
\usepackage{float}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\scaledwidth{\ImageWidthFraction\maxwidth}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\ImageWidthFraction\linewidth,height=\maxheight,keepaspectratio}

%% Force all images to be left-aligned (no centering)
\usepackage{caption}
\captionsetup{labelformat=empty,textformat=empty,justification=raggedright,singlelinecheck=false}

%% Completely override figure environment and centering to force left alignment
\makeatletter
% Override centering command globally to do left alignment
\renewcommand{\centering}{%
  \rightskip0pt plus 1fil
  \leftskip0pt
  \parfillskip0pt
  \raggedright
}
% Override center environment to be left-aligned
\renewenvironment{center}{%
  \par\noindent%
  \raggedright%
  \hspace{0pt}%
}{%
  \par%
}
% Completely replace figure environment - remove any text that might appear
\makeatletter
\renewenvironment{figure}[1][htbp]{%
  \def\@captype{figure}%
  \global\@opimagefalse
  % If in section 13 (ops) and this will be an op image, prevent orphan images
  \ifnum\value{section}=13\relax
    % Reserve space for op image + at least one line of text after
    \needspace{4\baselineskip}%
  \fi
  \par\vspace{\OpImageSpacing}%
  \noindent%
  \raggedright%
  \hspace{0pt}%
}{%
  \if@opimage
    % Op image: match before-space exactly by using negative space to cancel extra
    \par\vspace{-\baselineskip}% Cancel default spacing
    \vspace{-\parskip}% Cancel paragraph skip  
    \vspace{\OpImageSpacing}% Add exact spacing we want (same as before)
  \else
    % Regular figure: standard spacing
    \par\vspace{\baselineskip}%
  \fi
}
% Completely disable floatboxreset (which often centers)
\let\@floatboxreset\relax
\makeatother

%% Force left alignment for ALL includegraphics commands
%% Special handling for op images (in images/ops/ folder)
\makeatletter
\newif\if@opimage
\let\oldincludegraphics\includegraphics
\newcommand{\isopimage}[1]{%
  \IfSubStr{#1}{images/ops/}{\@firstoftwo}{\@secondoftwo}%
}
\renewcommand{\includegraphics}[2][]{%
  \isopimage{#2}{%
    % Op image: mark flag globally and insert image
    \global\@opimagetrue
    \noindent\oldincludegraphics[width=\OpImageWidthFraction\linewidth,keepaspectratio]{#2}%
  }{%
    % Regular image: use standard settings
    \global\@opimagefalse
    \par\noindent%
    \oldincludegraphics[#1]{#2}%
    \par%
  }%
}
\makeatother

%% TOC spacing
\usepackage{tocloft}
\setlength{\cftsecnumwidth}{2.5em}
\setlength{\cftsubsecnumwidth}{3.2em}
\setlength{\cftsubsubsecnumwidth}{4em}
\setlength{\cftparanumwidth}{4.8em}

%% Font fallbacks
\usepackage{fontspec}

%% Define colors using the variables above
\definecolor{sectiononecolor}{RGB}{\SectionOneColorRed,\SectionOneColorGreen,\SectionOneColorBlue}
\definecolor{sectiontwocolor}{RGB}{\SectionTwoColorRed,\SectionTwoColorGreen,\SectionTwoColorBlue}
\definecolor{sectionthreecolor}{RGB}{\SectionThreeColorRed,\SectionThreeColorGreen,\SectionThreeColorBlue}
\definecolor{sectionfourcolor}{RGB}{\SectionFourColorRed,\SectionFourColorGreen,\SectionFourColorBlue}
\definecolor{linkblue}{RGB}{0,102,204}
\definecolor{inputportsymbol}{RGB}{\InputPortSymbolRed,\InputPortSymbolGreen,\InputPortSymbolBlue}
\definecolor{outputportsymbol}{RGB}{\OutputPortSymbolRed,\OutputPortSymbolGreen,\OutputPortSymbolBlue}

%% Commands for colored port symbols (with space after)
\newcommand{\inputsymbol}{\textcolor{inputportsymbol}{\textgreater} }
\newcommand{\outputsymbol}{\textcolor{outputportsymbol}{\textless} }

%% Custom header styles using the settings above
\usepackage{titlesec}

%% Section 1 - largest (chapter titles)
\titleformat{\section}
  {\fontsize{\SectionOneFontSize}{\SectionOneLeading}\bfseries\color{sectiononecolor}}
  {\thesection}{1em}{}

%% Section 2 (major sections)
\titleformat{\subsection}
  {\fontsize{\SectionTwoFontSize}{\SectionTwoLeading}\bfseries\color{sectiontwocolor}}
  {\thesubsection}{1em}{}

%% Section 3 (subsections)
\titleformat{\subsubsection}
  {\fontsize{\SectionThreeFontSize}{\SectionThreeLeading}\bfseries\color{sectionthreecolor}}
  {\thesubsubsection}{1em}{}
%% Reduce spacing after ### headings (before op images)
%% Format: \titlespacing{command}{left}{before-sep}{after-sep}
\titlespacing*{\subsubsection}{0pt}{\SectionThreeSpacingBefore}{\SectionThreeSpacingAfter}

%% Apply reduced paragraph spacing to ops sections (section 13 content)
%% Also prevent orphans (op names alone at page bottom)
\makeatletter
\pretocmd{\subsubsection}{%
  \ifnum\value{section}=13\relax
    \setlength{\parskip}{\OpParagraphSpacing}%
    % Prevent orphan op names - require at least 3 lines after heading
    \needspace{3\baselineskip}%
  \fi
}{}{}
\makeatother

%% Orphan and widow control
\clubpenalty=10000      % Prevent orphan lines at start of page
\widowpenalty=10000     % Prevent widow lines at end of page
\displaywidowpenalty=10000  % Prevent widows in display math

%% Section 4 / Paragraph - not numbered
\titleformat{\paragraph}
  {\fontsize{\SectionFourFontSize}{\SectionFourLeading}\bfseries\color{sectionfourcolor}}
  {}{0em}{}

%% Set section numbering depth to 3
\setcounter{secnumdepth}{3}

%% Code block styling
\usepackage{fancyvrb}
\usepackage[framemethod=tikz]{mdframed}

% Card background (shared by code blocks + video cards)
\colorlet{cardbg}{black!\CardGrayPercent}

\mdfdefinestyle{cardstyle}{
    backgroundcolor=cardbg,
    linecolor=cardbg,
    linewidth=0pt,
    innerleftmargin=\CardPaddingX,
    innerrightmargin=\CardPaddingX,
    innertopmargin=\CardPaddingY,
    innerbottommargin=\CardPaddingY,
    leftmargin=0pt,
    rightmargin=0pt,
    roundcorner=\CardCornerRadius,
    skipabove=1.5\baselineskip,
    skipbelow=\baselineskip
}

% Code blocks use the same card style
\mdfdefinestyle{codeboxstyle}{style=cardstyle}

% Video cards use the same card style
\mdfdefinestyle{videocardstyle}{style=cardstyle}

% Make code blocks span both columns if they're wide (in 2-column mode)
% Note: This will be handled at document level, not in preamble

%% Set code block line spacing and font size using the settings above
\DefineVerbatimEnvironment{Verbatim}{Verbatim}{
    baselinestretch=\CodeBlockLineSpacing,
    fontsize=\CodeBlockFontSize pt
}

\surroundwithmdframed[style=codeboxstyle]{Verbatim}
\surroundwithmdframed[style=codeboxstyle]{verbatim}

%% Page headers and footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{} % Clear all headers and footers
\fancyfoot[R]{\raisebox{\FooterVerticalOffset}{\thepage}} % Right-aligned page number with vertical offset
\renewcommand{\headrulewidth}{0pt} % No header rule
\renewcommand{\footrulewidth}{0pt} % No footer rule

% Set header and footer heights with vertically centered page number
\setlength{\headheight}{\HeaderHeight pt}
\setlength{\footskip}{\FooterSkip}

% Vertically center page number in footer
\fancyfootoffset{0pt}
\renewcommand{\footruleskip}{0pt}

% Fix page 1 (plain style) to also have right-aligned page number
\fancypagestyle{plain}{%
  \fancyhf{} % Clear all headers and footers
  \fancyfoot[R]{\raisebox{\FooterVerticalOffset}{\thepage}} % Right-aligned page number with vertical offset
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

%% Link colors and final image alignment fixes
\AtBeginDocument{
  \hypersetup{
    colorlinks=true,
    linkcolor=sectiononecolor,
    urlcolor=linkblue,
    citecolor=sectiononecolor,
    filecolor=sectiononecolor
  }
  % Final override to ensure figures are left-aligned
  \makeatletter
  \renewcommand{\centering}{%
    \rightskip0pt plus 1fil
    \leftskip0pt
    \parfillskip0pt
    \raggedright
  }
  \renewenvironment{center}{%
    \par\noindent%
    \raggedright%
    \hspace{0pt}%
  }{%
    \par%
  }
  % Make TOC span both columns (longtable requires 1-column mode)
  \let\oldtableofcontents\tableofcontents
  \renewcommand{\tableofcontents}{%
    \if@twocolumn
      \onecolumn
      \oldtableofcontents
      \twocolumn
    \else
      \oldtableofcontents
    \fi
  }
  % Code blocks will stay in their column for now
  % (Can be enhanced later to span both columns if needed)
  \makeatother
}

% Patch longtable to work in 2-column mode
% We'll register hooks after document begins to avoid mode issues
\AtBeginDocument{
  \makeatletter
  \newif\iflongtabletwocol
  \let\origlongtable\longtable
  \let\endoriglongtable\endlongtable
  % Automatically switch to single column for longtable, then restore
  \renewenvironment{longtable}{%
    \if@twocolumn
      \longtabletwocoltrue
      \onecolumn
      \global\@twocolumnfalse % Satisfy longtable's 1-column requirement
    \else
      \longtabletwocolfalse
    \fi
    \origlongtable
  }{%
    \endoriglongtable
    \iflongtabletwocol
      \twocolumn
    \fi
  }
  \makeatother
}
